# Aè‚¡/æ¸¯è‚¡æ™ºèƒ½åˆ†æç³»ç»Ÿ - æŠ€æœ¯åˆ†ææ–‡æ¡£

æœ¬æ–‡æ¡£ä»ç›®å½•åˆ’åˆ†ã€æ¶æ„ã€æç¤ºè¯ç³»ç»Ÿã€æ¨¡å—å®ç°ä¸å…³è”ã€æ¸¯è‚¡æ”¯æŒä¸å—å‘èµ„é‡‘ã€æ–°äººå¼€å‘æŒ‡å—ã€UML å›¾ç­‰æ–¹é¢å¯¹é¡¹ç›®è¿›è¡Œå®Œæ•´åˆ†æã€‚

---

## ç›®å½•

```
daily_stock_analysis/
â”œâ”€â”€ main.py                 # ä¸»ç¨‹åºå…¥å£ï¼Œæµç¨‹è°ƒåº¦
â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†ï¼ˆå•ä¾‹ï¼Œ.envï¼‰
â”œâ”€â”€ analyzer.py              # AI åˆ†æå±‚ï¼ˆGemini/OpenAIï¼Œå†³ç­–ä»ªè¡¨ç›˜æç¤ºè¯ï¼‰
â”œâ”€â”€ stock_analyzer.py        # è¶‹åŠ¿åˆ†æå™¨ï¼ˆMA/ä¹–ç¦»ç‡/é‡èƒ½ï¼Œè§„åˆ™å¼•æ“ï¼‰
â”œâ”€â”€ market_analyzer.py       # å¤§ç›˜å¤ç›˜ï¼ˆæŒ‡æ•°/æ¿å—/åŒ—å‘/å—å‘/æ¸¯è‚¡æŒ‡æ•°/æ–°é—» + LLM æŠ¥å‘Šï¼‰
â”œâ”€â”€ search_service.py       # æ–°é—»æœç´¢æœåŠ¡ï¼ˆTavily/SerpAPIï¼Œå¤šç»´åº¦æƒ…æŠ¥ï¼‰
â”œâ”€â”€ notification.py         # æ¶ˆæ¯æ¨é€ï¼ˆä¼ä¸šå¾®ä¿¡ã€å†³ç­–ä»ªè¡¨ç›˜æŠ¥å‘Šç”Ÿæˆï¼‰
â”œâ”€â”€ storage.py               # å­˜å‚¨å±‚ï¼ˆSQLiteï¼Œæ—¥çº¿æ•°æ®ä¸åˆ†æä¸Šä¸‹æ–‡ï¼‰
â”œâ”€â”€ scheduler.py             # å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥å®šç‚¹æ‰§è¡Œã€ä¼˜é›…é€€å‡ºï¼‰
â”œâ”€â”€ data_provider/           # æ•°æ®æºç­–ç•¥å±‚
â”‚   â”œâ”€â”€ __init__.py         # å¯¼å‡º BaseFetcher, DataFetcherManager, å„ Fetcher
â”‚   â”œâ”€â”€ base.py             # BaseFetcher æŠ½è±¡åŸºç±»ã€DataFetcherManager æ•…éšœåˆ‡æ¢
â”‚   â”œâ”€â”€ akshare_fetcher.py   # AkShareï¼ˆAè‚¡/æ¸¯è‚¡æ—¥çº¿ + å®æ—¶è¡Œæƒ… + Aè‚¡ç­¹ç ï¼›æ¸¯è‚¡æ— ç­¹ç ï¼‰
â”‚   â”œâ”€â”€ tushare_fetcher.py   # Tushare Pro
â”‚   â”œâ”€â”€ baostock_fetcher.py  # Baostock
â”‚   â””â”€â”€ yfinance_fetcher.py  # YFinance
â”œâ”€â”€ .github/workflows/       # GitHub Actions æ¯æ—¥åˆ†æ
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â”œâ”€â”€ data/                    # SQLite æ•°æ®åº“ç›®å½•
â”œâ”€â”€ logs/                    # æ—¥å¿—ç›®å½•
â””â”€â”€ sources/                 # é™æ€èµ„æºï¼ˆç¤ºä¾‹å›¾ç­‰ï¼‰
```

---

## æ¶æ„

æ•´ä½“ä¸º**åˆ†å±‚ + ç­–ç•¥/ç®¡é“**ç»“æ„ï¼š

| å±‚æ¬¡ | èŒè´£ | ä¸»è¦æ¨¡å— |
|------|------|----------|
| **å…¥å£ä¸è°ƒåº¦** | å‘½ä»¤è¡Œè§£æã€æµç¨‹ç¼–æ’ã€å¹¶å‘æ§åˆ¶ã€å¼‚å¸¸éš”ç¦» | `main.py`ï¼ˆStockAnalysisPipelineï¼‰ |
| **é…ç½®** | å•ä¾‹é…ç½®ã€ç¯å¢ƒå˜é‡ã€æ ¡éªŒ | `config.py`ï¼ˆConfigï¼‰ |
| **AI åˆ†æ** | å¤§æ¨¡å‹è°ƒç”¨ã€å†³ç­–ä»ªè¡¨ç›˜æç¤ºè¯ã€ç»“æœè§£æ | `analyzer.py`ï¼ˆGeminiAnalyzerï¼‰ |
| **è§„åˆ™åˆ†æ** | è¶‹åŠ¿/å‡çº¿/ä¹–ç¦»ç‡/é‡èƒ½/ä¹°ç‚¹ä¿¡å· | `stock_analyzer.py`ï¼ˆStockTrendAnalyzerï¼‰ |
| **å¤§ç›˜å¤ç›˜** | æŒ‡æ•°/æ¿å—/åŒ—å‘/å—å‘/æ¸¯è‚¡æŒ‡æ•°/æ–°é—» + LLM ç”Ÿæˆå¤ç›˜æŠ¥å‘Š | `market_analyzer.py`ï¼ˆMarketAnalyzerï¼‰ |
| **æœç´¢** | å¤šå¼•æ“ã€å¤šç»´åº¦æƒ…æŠ¥ã€è´Ÿè½½å‡è¡¡ | `search_service.py`ï¼ˆSearchServiceï¼‰ |
| **é€šçŸ¥** | ä¼ä¸šå¾®ä¿¡æ¨é€ã€å†³ç­–ä»ªè¡¨ç›˜æŠ¥å‘Šç”Ÿæˆä¸è½ç›˜ | `notification.py`ï¼ˆNotificationServiceï¼‰ |
| **å­˜å‚¨** | SQLite ORMã€æ—¥çº¿å­˜å–ã€åˆ†æä¸Šä¸‹æ–‡ã€æ–­ç‚¹ç»­ä¼  | `storage.py`ï¼ˆDatabaseManagerï¼‰ |
| **è°ƒåº¦** | æ¯æ—¥å®šæ—¶ã€ä¿¡å·å¤„ç†ã€ç«‹å³æ‰§è¡Œä¸€æ¬¡ | `scheduler.py`ï¼ˆSchedulerï¼‰ |
| **æ•°æ®æº** | å¤šæ•°æ®æºç­–ç•¥ã€æ•…éšœåˆ‡æ¢ã€æ—¥çº¿æ ‡å‡†åŒ– | `data_provider/`ï¼ˆBaseFetcher + Managerï¼‰ |

**è®¾è®¡è¦ç‚¹**ï¼š

- **ç­–ç•¥æ¨¡å¼**ï¼šæ•°æ®æºï¼ˆBaseFetcherï¼‰ã€æœç´¢å¼•æ“ï¼ˆBaseSearchProviderï¼‰å¯æ’æ‹”ã€å¯æ‰©å±•ã€‚
- **å•ä¾‹**ï¼šConfigã€DatabaseManager å…¨å±€å”¯ä¸€ã€‚
- **ç®¡é“å¼æµç¨‹**ï¼šå•åªè‚¡ç¥¨ä¸ºã€Œæ‹‰æ•°æ® â†’ å­˜åº“ â†’ å®æ—¶/ç­¹ç /è¶‹åŠ¿ â†’ æœç´¢ â†’ ç»„ä¸Šä¸‹æ–‡ â†’ AI åˆ†æ â†’ æ±‡æ€»é€šçŸ¥ã€ã€‚
- **ä½å¹¶å‘**ï¼šçº¿ç¨‹æ±  `max_workers` é»˜è®¤ 3ï¼Œé…åˆè¯·æ±‚é—´éš”ä¸éšæœºä¼‘çœ ï¼Œé™ä½è¢«å°é£é™©ã€‚

---

## æç¤ºè¯ç³»ç»Ÿä»‹ç»

é¡¹ç›®ä¸­æœ‰ä¸¤å¥—ä¸ LLM ç›¸å…³çš„æç¤ºè¯ï¼š**ä¸ªè‚¡å†³ç­–ä»ªè¡¨ç›˜**ï¼ˆanalyzerï¼‰å’Œ**å¤§ç›˜å¤ç›˜**ï¼ˆmarket_analyzerï¼‰ã€‚

### 1. ä¸ªè‚¡å†³ç­–ä»ªè¡¨ç›˜ï¼ˆanalyzer.pyï¼‰

- **è§’è‰²**ï¼š`SYSTEM_PROMPT` å®šä¹‰ã€Œä¸“æ³¨è¶‹åŠ¿äº¤æ˜“çš„ A è‚¡/æ¸¯è‚¡æŠ•èµ„åˆ†æå¸ˆã€ï¼Œè¾“å‡ºä¸º**å†³ç­–ä»ªè¡¨ç›˜**ã€‚æ¸¯è‚¡æ ‡çš„ï¼ˆ5 ä½ä»£ç å¦‚ 00700ï¼‰æ— ç­¹ç æ•°æ®æ—¶ä»¥è¶‹åŠ¿ä¸é‡ä»·ã€å—å‘èµ„é‡‘ç¯å¢ƒä¸ºä¸»ã€‚
- **äº¤æ˜“ç†å¿µï¼ˆç¡¬çº¦æŸï¼‰**ï¼š
  - **ä¸¥è¿›**ï¼šä¹–ç¦»ç‡ (ç°ä»·-MA5)/MA5 > 5% ä¸ä¹°ï¼Œç›´æ¥è§‚æœ›ã€‚
  - **è¶‹åŠ¿**ï¼šå¤šå¤´æ’åˆ— MA5 > MA10 > MA20ã€‚
  - **æ•ˆç‡**ï¼šA è‚¡å…³æ³¨ç­¹ç  90% é›†ä¸­åº¦ã€è·åˆ©æ¯”ä¾‹ï¼›æ¸¯è‚¡è‹¥æ— ç­¹ç æ•°æ®åˆ™ä»¥é‡ä»·ä¸å—å‘èµ„é‡‘æ›¿ä»£ã€‚
  - **ä¹°ç‚¹**ï¼šç¼©é‡å›è¸© MA5/MA10 æ”¯æ’‘ä¸ºä½³ã€‚
  - **é£é™©**ï¼šå‡æŒã€ä¸šç»©å˜è„¸ã€ç›‘ç®¡ã€è§£ç¦ç­‰å¿…é¡»ä½“ç°ï¼›æ¸¯è‚¡éœ€å…³æ³¨å—å‘èµ„é‡‘ã€æ±‡ç‡ã€æ’ç”Ÿç§‘æŠ€æƒ…ç»ªã€‚
- **è¾“å‡ºç»“æ„**ï¼šè¦æ±‚æ¨¡å‹è¾“å‡º**ä¸¥æ ¼ JSON**ï¼ŒåŒ…å«ï¼š
  - `sentiment_score`ã€`trend_prediction`ã€`operation_advice`ã€`confidence_level`
  - `dashboard`ï¼š`core_conclusion`ï¼ˆä¸€å¥è¯ç»“è®ºã€ä¿¡å·ç±»å‹ã€ç©ºä»“/æŒä»“å»ºè®®ï¼‰ã€`data_perspective`ï¼ˆè¶‹åŠ¿/ä»·æ ¼/é‡èƒ½/ç­¹ç ï¼‰ã€`intelligence`ï¼ˆæ–°é—»/é£é™©/åˆ©å¥½/ä¸šç»©é¢„æœŸï¼‰ã€`battle_plan`ï¼ˆç‹™å‡»ç‚¹ä½ã€ä»“ä½ã€æ£€æŸ¥æ¸…å• âœ…âš ï¸âŒï¼‰
  - ä»¥åŠ `trend_analysis`ã€`technical_analysis`ã€`news_summary` ç­‰é•¿æ–‡æœ¬å­—æ®µã€‚
- **ç”¨æˆ· Prompt ç»„æˆ**ï¼ˆ`_format_prompt`ï¼‰ï¼š
  - åŸºç¡€ä¿¡æ¯ï¼šä»£ç ã€åç§°ã€æ—¥æœŸã€‚
  - æŠ€æœ¯é¢ï¼šä»Šæ”¶/å¼€é«˜ä½ã€æ¶¨è·Œå¹…ã€é‡é¢ã€å‡çº¿ã€å‡çº¿å½¢æ€ã€‚
  - å®æ—¶å¢å¼ºï¼šå½“å‰ä»·ã€é‡æ¯”ã€æ¢æ‰‹ç‡ã€PE/PBã€å¸‚å€¼ã€60 æ—¥æ¶¨è·Œã€‚
  - ç­¹ç ï¼šè·åˆ©æ¯”ä¾‹ã€å¹³å‡æˆæœ¬ã€é›†ä¸­åº¦ã€ç­¹ç çŠ¶æ€ã€‚
  - è¶‹åŠ¿é¢„åˆ¤ï¼šè¶‹åŠ¿åˆ†æå™¨ç»™å‡ºçš„è¶‹åŠ¿çŠ¶æ€ã€ä¹–ç¦»ç‡ã€é‡èƒ½ã€ç³»ç»Ÿä¿¡å·ä¸ç†ç”±/é£é™©ã€‚
  - èˆ†æƒ…ï¼š`search_service` å¤šç»´åº¦æƒ…æŠ¥æ ¼å¼åŒ–åçš„æ–‡æœ¬ã€‚
  - ç»“å°¾ï¼šæ˜ç¡® 5 ä¸ªå¿…é¡»å›ç­”çš„é—®é¢˜ + å†³ç­–ä»ªè¡¨ç›˜è¾“å‡ºè¦æ±‚ã€‚

è§£ææ—¶å…ˆæŠ å‡º JSON å—ï¼Œå†åš `_fix_json_string` æ¸…æ´—ã€`_parse_response` å¡«æ»¡ `AnalysisResult`ï¼›è‹¥ JSON å¤±è´¥åˆ™èµ° `_parse_text_response` åšç®€å•å…³é”®è¯æƒ…ç»ªå…œåº•ã€‚

### 2. å¤§ç›˜å¤ç›˜ï¼ˆmarket_analyzer.pyï¼‰

- **è§’è‰²**ï¼š`_build_review_prompt` ä¸­å®šä¹‰ä¸ºã€Œä¸“ä¸š A è‚¡ä¸æ¸¯è‚¡å¸‚åœºåˆ†æå¸ˆã€ï¼Œæ ¹æ®å½“æ—¥å¸‚åœºæ•°æ®ç”Ÿæˆ**çº¯ Markdown å¤ç›˜æŠ¥å‘Š**ï¼ˆæ¶µç›– A è‚¡ä¸æ¸¯è‚¡/æ’ç”Ÿç§‘æŠ€ã€åŒ—å‘ä¸å—å‘èµ„é‡‘ï¼‰ã€‚
- **è¾“å…¥**ï¼š`MarketOverview`ï¼ˆæ—¥æœŸã€ä¸»è¦æŒ‡æ•°ã€æ¶¨è·Œå®¶æ•°ã€æ¶¨åœè·Œåœã€æˆäº¤é¢ã€åŒ—å‘ã€å—å‘ã€æ¸¯è‚¡æŒ‡æ•°ã€é¢†æ¶¨é¢†è·Œæ¿å—ï¼‰+ æœç´¢å¾—åˆ°çš„å¸‚åœºæ–°é—»åˆ—è¡¨ã€‚
- **æ ¼å¼çº¦æŸ**ï¼šçº¯ Markdownã€ç¦æ­¢ JSON/ä»£ç å—ã€emoji ä»…æ ‡é¢˜å°‘é‡ä½¿ç”¨ã€‚
- **è¾“å‡ºæ¨¡æ¿**ï¼š  
  ã€ŒğŸ“Š æ—¥æœŸ å¤§ç›˜å¤ç›˜ã€â†’ ä¸€ã€å¸‚åœºæ€»ç»“ â†’ äºŒã€æŒ‡æ•°ç‚¹è¯„ â†’ ä¸‰ã€èµ„é‡‘åŠ¨å‘ï¼ˆå«åŒ—å‘/å—å‘ï¼‰â†’ å››ã€çƒ­ç‚¹è§£è¯» â†’ äº”ã€åå¸‚å±•æœ› â†’ å…­ã€é£é™©æç¤ºã€‚
- **è°ƒç”¨æ–¹å¼**ï¼šè‹¥é…ç½®äº† `analyzer` ä¸”å¯ç”¨ï¼Œåˆ™ç”¨å…¶ `_model.generate_content` æˆ– `_call_openai_api` ç”Ÿæˆï¼›å¦åˆ™é€€å› `_generate_template_review` æ¨¡æ¿æŠ¥å‘Šã€‚

ä¸¤å¥—æç¤ºè¯å…±åŒç‚¹ï¼šéƒ½å¼ºè°ƒ**ç»“æ„åŒ–è¾“å‡º**ï¼ˆä»ªè¡¨ç›˜ JSON / å¤ç›˜ Markdown å°èŠ‚ï¼‰ï¼Œå¹¶çº¦æŸé£æ ¼ä¸é£é™©æç¤ºã€‚

---

## æ¸¯è‚¡æ”¯æŒè¯´æ˜

ç³»ç»Ÿæ”¯æŒ **A è‚¡ä¸æ¸¯è‚¡** ç»Ÿä¸€ç®¡é“åˆ†æï¼Œæ•°æ®ä¸å¤ç›˜å‡è¦†ç›–æ¸¯è‚¡ç›¸å…³ç»´åº¦ã€‚

### æ¸¯è‚¡ä»£ç çº¦å®š

- **ä»£ç æ ¼å¼**ï¼š5 ä½æ•°å­—ä¸ºæ¸¯è‚¡ï¼ˆå¦‚ `00700` è…¾è®¯ã€`09988` é˜¿é‡Œï¼‰ï¼Œ6 ä½ä¸º A è‚¡ï¼›å¸¦ `.HK` åç¼€ä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºæ¸¯è‚¡ã€‚
- **é…ç½®**ï¼šåœ¨ `STOCK_LIST` ä¸­ç›´æ¥åŠ å…¥æ¸¯è‚¡ä»£ç å³å¯ï¼Œä¾‹å¦‚ï¼š`600519,00700,09988`ã€‚

### æ•°æ®å±‚ï¼ˆdata_provider/akshare_fetcher.pyï¼‰

| èƒ½åŠ›       | Aè‚¡ | æ¸¯è‚¡ |
|------------|-----|------|
| æ—¥çº¿       | `stock_zh_a_hist` | `stock_hk_hist` |
| å®æ—¶è¡Œæƒ…   | `stock_zh_a_spot_em` | `stock_hk_spot_em` |
| ç­¹ç åˆ†å¸ƒ   | `stock_cyq_em` | æš‚ä¸æ”¯æŒï¼ˆè¿”å› Noneï¼Œåˆ†æä»¥è¶‹åŠ¿ä¸é‡ä»·ä¸ºä¸»ï¼‰ |

- **å¸‚åœºåˆ¤å®š**ï¼š`AkshareFetcher.is_hk(code)` ä¸º True æ—¶èµ°æ¸¯è‚¡æ¥å£ï¼Œå­˜å‚¨ä¸ pipeline ä¸ A è‚¡å…±ç”¨ï¼ˆæŒ‰ `code` åŒºåˆ†ï¼‰ã€‚

### å¤§ç›˜å¤ç›˜ï¼ˆmarket_analyzer.pyï¼‰

- **å—å‘èµ„é‡‘**ï¼š`stock_hsgt_north_net_flow_in_em(symbol="å—ä¸‹")`ï¼Œå†™å…¥ `MarketOverview.south_flow`ï¼ˆäº¿å…ƒï¼‰ã€‚
- **æ¸¯è‚¡æŒ‡æ•°**ï¼šè‹¥ akshare æä¾› `stock_hk_index_spot_em`ï¼Œåˆ™æ‹‰å–æ’ç”Ÿç§‘æŠ€ã€æ’ç”ŸæŒ‡æ•°ç­‰å¡«å…¥ `overview.hk_indices`ï¼›å¦åˆ™è·³è¿‡ã€‚
- **å¤ç›˜æç¤ºè¯**ï¼šè¦æ±‚æ¨¡å‹åŒæ—¶è§£è¯» A è‚¡æŒ‡æ•°ã€æ¸¯è‚¡æŒ‡æ•°ï¼ˆæ’ç”Ÿç§‘æŠ€ç­‰ï¼‰ã€åŒ—å‘èµ„é‡‘ä¸å—å‘èµ„é‡‘ï¼›æœç´¢å¢åŠ ã€Œæ¸¯è‚¡ æ’ç”Ÿç§‘æŠ€ å—å‘èµ„é‡‘ã€ç­‰ queryã€‚

### æç¤ºè¯ä¸æ¨é€

- **analyzer**ï¼šSYSTEM_PROMPT ä¸­åŒºåˆ† A è‚¡/æ¸¯è‚¡ï¼ˆæ¸¯è‚¡æ— æ¶¨è·Œåœã€å¯èƒ½æ— ç­¹ç ï¼Œéœ€å…³æ³¨å—å‘èµ„é‡‘ä¸æ’ç”Ÿç§‘æŠ€ç¯å¢ƒï¼‰ã€‚
- **notification**ï¼šè‹¥åˆ†æç»“æœä¸­åŒ…å«æ¸¯è‚¡ä»£ç ï¼ˆ5 ä½æ•°å­—ï¼‰ï¼Œæ—¥æŠ¥æ ‡é¢˜æ˜¾ç¤ºä¸ºã€ŒAè‚¡/æ¸¯è‚¡è‡ªé€‰è‚¡æ™ºèƒ½åˆ†ææŠ¥å‘Šã€ï¼Œæ¨é€å†…å®¹ä¸ A è‚¡ä¸€è‡´ï¼ˆå†³ç­–ä»ªè¡¨ç›˜ + å•æ¡æ¨é€ï¼‰ã€‚

### ä¿¡æ¯é¢ä¸æ’ç”Ÿç§‘æŠ€

- æƒ…æŠ¥æœç´¢æŒ‰è‚¡ç¥¨ä»£ç ä¸åç§°è¿›è¡Œï¼Œæ¸¯è‚¡ä¸ªè‚¡ä¼šæŒ‰åç§°æœç´¢ï¼›å¤§ç›˜å¤ç›˜ä¼šæœç´¢ã€Œæ¸¯è‚¡ æ’ç”Ÿç§‘æŠ€ å—å‘èµ„é‡‘ã€ç­‰ï¼Œä¿¡æ¯é¢è¦†ç›–æ¸¯è‚¡ä¸å—å‘èµ„é‡‘ã€‚

---

## å„ä¸ªæ¨¡å—çš„å…·ä½“å®ç°

### main.pyï¼ˆå…¥å£ä¸ç®¡é“ï¼‰

- **èŒè´£**ï¼šè§£æå‘½ä»¤è¡Œï¼ˆ`--debug/--dry-run/--stocks/--no-notify/--schedule/--market-review/--no-market-review`ï¼‰ï¼Œåˆå§‹åŒ–æ—¥å¿—ï¼Œæ ¡éªŒé…ç½®ï¼Œé€‰æ‹©è¿è¡Œæ¨¡å¼ã€‚
- **StockAnalysisPipeline**ï¼š
  - ä¾èµ–ï¼šConfigã€DatabaseManagerã€DataFetcherManagerã€AkshareFetcherï¼ˆå®æ—¶+ç­¹ç ï¼‰ã€StockTrendAnalyzerã€GeminiAnalyzerã€NotificationServiceã€SearchServiceã€‚
  - `fetch_and_save_stock_data(code)`ï¼šå…ˆ `db.has_today_data(code)` æ–­ç‚¹ç»­ä¼ ï¼›å¦åˆ™ `fetcher_manager.get_daily_data(code, days=30)`ï¼Œå† `db.save_daily_data(...)`ã€‚
  - `analyze_stock(code)`ï¼šå–å®æ—¶è¡Œæƒ…ä¸ç­¹ç ï¼ˆAkshareï¼‰â†’ ä» DB å– contextï¼Œè‹¥æœ‰ `raw_data` åˆ™åšè¶‹åŠ¿åˆ†æ â†’ è‹¥æœç´¢å¯ç”¨åˆ™ `search_comprehensive_intel` + `format_intel_report` â†’ å†æ¬¡ `get_analysis_context`ï¼Œ`_enhance_context` åŠ å…¥ realtime/chip/trend_analysis/stock_name â†’ `analyzer.analyze(enhanced_context, news_context)`ã€‚
  - `process_single_stock(code)`ï¼šå…ˆæ‹‰å­˜æ•°æ®ï¼Œå†ï¼ˆé dry-runï¼‰åˆ†æï¼Œå•è‚¡å¼‚å¸¸ä¸æ³¢åŠå…¶ä»–ã€‚
  - `run(stock_codes, dry_run, send_notification)`ï¼šçº¿ç¨‹æ± å¹¶å‘ `process_single_stock`ï¼Œæ”¶é›† `AnalysisResult`ï¼Œè‹¥éœ€é€šçŸ¥åˆ™ `_send_notifications`ï¼ˆç”Ÿæˆä»ªè¡¨ç›˜æŠ¥å‘Šã€è½ç›˜ã€ä¼ä¸šå¾®ä¿¡åˆ†æ¡å‘é€ï¼‰ã€‚
- **æ¨¡å¼**ï¼šä»…å¤§ç›˜å¤ç›˜ï¼ˆ`--market-review`ï¼‰ï¼›å®šæ—¶ï¼ˆ`--schedule` æˆ–é…ç½®ï¼‰è°ƒç”¨ `run_with_schedule(run_full_analysis)`ï¼›å¦åˆ™å•æ¬¡ `run_full_analysis`ï¼ˆä¸ªè‚¡ + å¯é€‰å¤§ç›˜å¤ç›˜ï¼‰ã€‚

### config.py

- **Config**ï¼šdataclassï¼Œä» `.env` åŠ è½½ï¼ˆ`_load_from_env`ï¼‰ï¼Œå•ä¾‹ `get_instance()`ã€‚
- é¡¹ï¼šstock_listã€tushare_tokenã€gemini/openai ç›¸å…³ã€tavily/serpapi keysã€wechat_webhook_urlã€database_pathã€log_dirã€max_workersã€schedule_enabledã€schedule_timeã€market_review_enabledã€akshare/tushare æµæ§ä¸é‡è¯•ç­‰ã€‚
- `validate()` è¿”å›ç¼ºå¤±/å»ºè®®åˆ—è¡¨ï¼›`get_db_url()` è¿”å› SQLite URL å¹¶ç¡®ä¿ç›®å½•å­˜åœ¨ã€‚

### analyzer.py

- **AnalysisResult**ï¼šdataclassï¼Œå« code/nameã€sentiment_scoreã€trend_predictionã€operation_adviceã€confidence_levelã€dashboardï¼ˆå« core_conclusion/battle_plan/intelligence ç­‰ï¼‰ã€å¤šæ®µåˆ†ææ–‡æœ¬ã€raw_responseã€success/error_messageï¼›æä¾› `get_core_conclusion`ã€`get_sniper_points`ã€`get_checklist`ã€`get_emoji` ç­‰ã€‚
- **GeminiAnalyzer**ï¼š  
  - åˆå§‹åŒ–ï¼šä¼˜å…ˆ Geminiï¼ˆä¸»/å¤‡é€‰æ¨¡å‹ï¼‰ï¼Œå¤±è´¥æˆ–æœªé…ç½®åˆ™ OpenAI å…¼å®¹ APIã€‚  
  - `analyze(context, news_context)`ï¼šè¯·æ±‚å‰å»¶æ—¶ â†’ ç»„ promptï¼ˆ`_format_prompt`ï¼‰â†’ `_call_api_with_retry`ï¼ˆé‡è¯• + é™æµæ—¶åˆ‡å¤‡é€‰æ¨¡å‹/Gemini å¤±è´¥åˆ‡ OpenAIï¼‰â†’ `_parse_response` è§£æ JSON å¡« AnalysisResultã€‚
- **STOCK_NAME_MAP**ï¼šå¸¸è§ä»£ç åˆ°åç§°çš„å…œåº•æ˜ å°„ã€‚

### stock_analyzer.py

- **æšä¸¾**ï¼šTrendStatusï¼ˆå¼ºåŠ¿å¤šå¤´/å¤šå¤´/å¼±åŠ¿å¤šå¤´/ç›˜æ•´/ç©ºå¤´ç­‰ï¼‰ã€VolumeStatusï¼ˆæ”¾é‡ä¸Šæ¶¨ä¸‹è·Œã€ç¼©é‡ä¸Šæ¶¨å›è°ƒã€æ­£å¸¸ï¼‰ã€BuySignalï¼ˆå¼ºçƒˆä¹°å…¥ï½å¼ºçƒˆå–å‡ºï¼‰ã€‚
- **TrendAnalysisResult**ï¼šcodeã€è¶‹åŠ¿çŠ¶æ€ã€å‡çº¿æ’åˆ—æè¿°ã€è¶‹åŠ¿å¼ºåº¦ã€MA5/10/20/60ã€ç°ä»·ã€ä¹–ç¦»ç‡ã€é‡èƒ½çŠ¶æ€ã€æ”¯æ’‘/å‹åŠ›ã€buy_signalã€signal_scoreã€signal_reasonsã€risk_factorsã€‚
- **StockTrendAnalyzer**ï¼š  
  - `analyze(df, code)`ï¼šè®¡ç®— MAã€å–æœ€æ–°ä¸€è¡Œ â†’ è¶‹åŠ¿åˆ¤æ–­ï¼ˆå‡çº¿æ’åˆ—ä¸å¼ºåº¦ï¼‰â†’ ä¹–ç¦»ç‡ â†’ é‡èƒ½ï¼ˆ5 æ—¥å‡é‡æ¯”ï¼‰â†’ æ”¯æ’‘å‹åŠ›ï¼ˆMA5/10/20 ä¸è¿‘æœŸé«˜ä½ï¼‰â†’ `_generate_signal` ç»¼åˆæ‰“åˆ†ï¼ˆè¶‹åŠ¿ 40 + ä¹–ç¦» 30 + é‡èƒ½ 20 + æ”¯æ’‘ 10ï¼‰ï¼Œè¾“å‡ºä¿¡å·ä¸ç†ç”±/é£é™©ã€‚  
  - å‚æ•°ï¼šBIAS_THRESHOLD=5%ã€ç¼©é‡/æ”¾é‡æ¯”ä¾‹ã€MA æ”¯æ’‘å®¹å¿åº¦ã€‚

### market_analyzer.py

- **MarketIndex / MarketOverview**ï¼šæŒ‡æ•°ä¸å¸‚åœºæ¦‚è§ˆæ•°æ®ç»“æ„ã€‚
- **MarketAnalyzer**ï¼š  
  - `get_market_overview()`ï¼šak å–æŒ‡æ•° spotã€å…¨ A spotï¼ˆæ¶¨è·Œ/æ¶¨è·Œåœï¼‰ã€è¡Œä¸šæ¿å—æ’åã€åŒ—å‘å‡€æµå…¥ï¼Œå¡« MarketOverviewã€‚  
  - `search_market_news()`ï¼šå¤šæŸ¥è¯¢è°ƒç”¨ `search_service.search_stock_news`ï¼ˆstock_code="market"ï¼‰ã€‚  
  - `generate_market_review(overview, news)`ï¼šæœ‰ analyzer åˆ™ `_build_review_prompt` + LLM ç”Ÿæˆï¼Œå¦åˆ™ `_generate_template_review`ã€‚  
  - `run_daily_review()`ï¼šget_market_overview â†’ search_market_news â†’ generate_market_reviewï¼Œè¿”å›æŠ¥å‘Šæ–‡æœ¬ã€‚

### search_service.py

- **SearchResult / SearchResponse**ï¼šå•æ¡ç»“æœä¸ä¸€æ¬¡æœç´¢å“åº”ï¼Œ`to_context(max_results)` ä¾› AI ç”¨ã€‚
- **BaseSearchProvider**ï¼šå¤š Key è½®è¯¢ã€é”™è¯¯è®¡æ•°ä¸è·³è¿‡ã€`_do_search` æŠ½è±¡ã€‚
- **TavilySearchProvider / SerpApiSearchProvider**ï¼šå®ç° `_do_search`ã€‚
- **SearchService**ï¼šæŒæœ‰ tavily/serpapi çš„ provider åˆ—è¡¨ï¼Œ`search(query, max_results)` æŒ‰åºå°è¯•ï¼›`search_stock_news(stock_code, stock_name, ...)` å°è£…è‚¡ç¥¨ç›¸å…³æŸ¥è¯¢ï¼›`search_comprehensive_intel(stock_code, stock_name, max_searches)` æ‰§è¡Œå¤šç»´åº¦ï¼ˆæœ€æ–°æ¶ˆæ¯ã€é£é™©æ’æŸ¥ã€ä¸šç»©é¢„æœŸç­‰ï¼‰å¹¶è¿”å› Dict[ç»´åº¦å, SearchResponse]ï¼›`format_intel_report` å°†å¤šç»´åº¦ç»“æœæ ¼å¼åŒ–ä¸ºä¸€æ®µç»™ LLM çš„æ–‡æœ¬ã€‚

### notification.py

- **NotificationService**ï¼š  
  - ä¼ä¸šå¾®ä¿¡ï¼š`send_to_wechat(content)` ä½¿ç”¨é…ç½®çš„ webhook å‘é€ Markdown/æ–‡æœ¬ã€‚  
  - å†³ç­–ä»ªè¡¨ç›˜ï¼š`generate_dashboard_report(results, report_date)` æ ¹æ® AnalysisResult åˆ—è¡¨ç”Ÿæˆå¸¦æ ¸å¿ƒç»“è®ºã€ç‹™å‡»ç‚¹ä½ã€æ£€æŸ¥æ¸…å•ã€é£é™©ç­‰å†…å®¹çš„æŠ¥å‘Šæ–‡æœ¬ã€‚  
  - `save_report_to_file(content, filename)` å†™å…¥æ–‡ä»¶ï¼›`send_batch_notifications(results)` å…ˆå‘æ±‡æ€»å†æŒ‰æ¡å‘å•è‚¡ï¼ˆé€‚é…ä¼ä¸šå¾®ä¿¡é•¿åº¦ä¸æ ¼å¼ï¼‰ã€‚

### storage.py

- **StockDaily**ï¼šORM è¡¨ stock_dailyï¼Œå­—æ®µ code/date/open/high/low/close/volume/amount/pct_chgã€ma5/10/20ã€volume_ratioã€data_sourceã€created_at/updated_atï¼›å”¯ä¸€çº¦æŸ (code, date)ã€‚
- **DatabaseManager**ï¼šå•ä¾‹ï¼ŒSQLite å¼•æ“ + sessionmakerã€‚  
  - `has_today_data(code, target_date)`ï¼šæŒ‰ code+date æŸ¥å­˜åœ¨ã€‚  
  - `save_daily_data(df, code, data_source)`ï¼šæŒ‰ code+date UPSERTï¼Œè®¡ç®—å¹¶å†™å…¥ ma/volume_ratioï¼Œè¿”å›å†™å…¥æ¡æ•°ã€‚  
  - `get_latest_data(code, days)`ï¼šæŒ‰æ—¥æœŸé™åºå–æœ€è¿‘ N æ¡ã€‚  
  - `get_analysis_context(code, target_date)`ï¼šæœ€è¿‘ 2 æ¡ â†’ ä»Šæ—¥/æ˜¨æ—¥ dictã€volume_change_ratioã€price_change_ratioã€`_analyze_ma_status` çš„ ma_statusï¼›**ä¸åŒ…å«** raw_dataï¼ˆè¶‹åŠ¿åˆ†æè‹¥éœ€å†å² K çº¿éœ€å¦ä» DB å–å¤šæ—¥æˆ–ç”±ä¸Šå±‚æ‹¼è£…ï¼‰ã€‚  

### scheduler.py

- **GracefulShutdown**ï¼šæ³¨å†Œ SIGINT/SIGTERMï¼Œç½®ä½ `should_shutdown`ã€‚
- **Scheduler**ï¼šç”¨ `schedule` åº“ `every().day.at(schedule_time).do(_safe_run_task)`ï¼Œå¯ `run_immediately` æ‰§è¡Œä¸€æ¬¡ï¼›`run()` å¾ªç¯ `run_pending()` + sleep(30)ï¼Œç›´åˆ° `should_shutdown`ã€‚
- **run_with_schedule(task, schedule_time, run_immediately)**ï¼šåˆ›å»º Schedulerã€set_daily_taskã€run()ã€‚

### data_provider/base.py ä¸ data_provider/*.py

- **BaseFetcher**ï¼šæŠ½è±¡ `_fetch_raw_data`ã€`_normalize_data`ï¼›`get_daily_data(stock_code, start_date, end_date, days)` å†…éƒ¨ï¼šç®—æ—¥æœŸ â†’ _fetch_raw_data â†’ _normalize_data â†’ _clean_data â†’ _calculate_indicatorsï¼ˆMA5/10/20ã€volume_ratioï¼‰ï¼Œåˆ—åç»Ÿä¸€ä¸º STANDARD_COLUMNSã€‚
- **DataFetcherManager**ï¼šç»´æŠ¤ Fetcher åˆ—è¡¨ï¼ˆæŒ‰ priorityï¼‰ï¼Œ`get_daily_data(code, days=30)` ä¾æ¬¡å°è¯•ï¼ŒæˆåŠŸå³è¿”å› (df, source_name)ï¼Œå…¨å¤±è´¥æŠ›å¼‚å¸¸ã€‚
- **AkshareFetcher**ï¼šé™¤æ—¥çº¿å¤–ï¼Œæä¾›å®æ—¶è¡Œæƒ…ï¼ˆé‡æ¯”ã€æ¢æ‰‹ç‡ç­‰ï¼‰ä¸ç­¹ç åˆ†å¸ƒæ¥å£ï¼Œä¾› main ç®¡é“å¢å¼ºä¸Šä¸‹æ–‡ã€‚
- å…¶ä»– Fetcherï¼šå®ç°å„è‡ª `_fetch_raw_data`ã€`_normalize_data`ï¼Œå¹¶è®¾ç½® priorityã€‚

---

## å„ä¸ªæ¨¡å—ä¹‹é—´çš„å…³è”å…³ç³»

- **main â†’ å…¨éƒ¨**ï¼šmain è¯» Configï¼Œåˆ›å»º DBã€DataFetcherManagerã€AkshareFetcherã€StockTrendAnalyzerã€GeminiAnalyzerã€NotificationServiceã€SearchServiceï¼Œå¹¶ç¼–æ’è°ƒç”¨é¡ºåºã€‚
- **æ•°æ®æµ**ï¼š  
  - æ•°æ®è·å–ï¼šmain ç”¨ DataFetcherManager æ‹‰æ—¥çº¿ â†’ storage å­˜ï¼›main ç”¨ AkshareFetcher å–å®æ—¶ä¸ç­¹ç ã€‚  
  - åˆ†æä¸Šä¸‹æ–‡ï¼šstorage.get_analysis_context æä¾›ä»Šæ—¥/æ˜¨æ—¥ä¸ ma_statusï¼›main åœ¨å†…å­˜ä¸­å åŠ  realtimeã€chipã€trend_analysisï¼ˆè‹¥ä» DB æˆ–åˆ«å¤„æ‹¿åˆ°è¶³å¤Ÿ K çº¿åˆ™è°ƒç”¨ StockTrendAnalyzerï¼‰ã€stock_nameï¼Œå¾—åˆ° enhanced_contextã€‚  
  - èˆ†æƒ…ï¼šSearchService.search_comprehensive_intel + format_intel_report â†’ news_context å­—ç¬¦ä¸²ã€‚  
  - AIï¼šanalyzer.analyze(enhanced_context, news_context) â†’ AnalysisResultã€‚  
  - é€šçŸ¥ï¼šnotification.generate_dashboard_report(results) â†’ æ–‡æœ¬ï¼›save_report_to_fileï¼›send_batch_notificationsï¼ˆå†…éƒ¨ send_to_wechatï¼‰ã€‚
- **å¤§ç›˜å¤ç›˜**ï¼šmain åœ¨ç›¸åº”æ¨¡å¼ä¸‹åˆ›å»º MarketAnalyzer(search_service, analyzer)ï¼Œè°ƒç”¨ run_daily_review()ï¼›MarketAnalyzer å†…éƒ¨ç”¨ akshare æ‹¿æŒ‡æ•°/æ¿å—/åŒ—å‘ï¼Œç”¨ search_service æ‹¿å¸‚åœºæ–°é—»ï¼Œç”¨ analyzer çš„ LLM æˆ–æ¨¡æ¿ç”Ÿæˆå¤ç›˜æŠ¥å‘Šï¼Œå†ç”± main ç”¨ notifier.send_to_wechat æ¨é€ã€‚
- **é…ç½®**ï¼šConfig è¢« configã€storageã€analyzerã€mainã€search_serviceã€notificationã€data_provider ç­‰é—´æ¥æˆ–ç›´æ¥ä½¿ç”¨ã€‚
- **ä¾èµ–æ–¹å‘**ï¼š  
  - ä¸Šå±‚ä¸ç›´æ¥ä¾èµ–ä¸‹å±‚å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯ä¾èµ–æ¥å£æˆ–ç¨³å®š APIï¼ˆå¦‚ get_daily_dataã€get_analysis_contextã€analyzeã€search_comprehensive_intelã€send_to_wechat ç­‰ï¼‰ã€‚  
  - æ•°æ®æºä¸æœç´¢ä¸ºå¯æ›¿æ¢ç­–ç•¥ï¼Œé€šè¿‡ base + manager ç»Ÿä¸€å…¥å£ã€‚

---

## æ¸¯è‚¡æ”¯æŒä¸å—å‘èµ„é‡‘

### æ¸¯è‚¡æ ‡çš„è¯†åˆ«ä¸æ•°æ®æ¥å£ï¼ˆAkshareï¼‰

- **ä»£ç çº¦å®š**ï¼šæ¸¯è‚¡ä»£ç ä¸º 5 ä½æ•°å­—ï¼ˆå¦‚ 00700ã€09988ï¼‰ï¼Œæˆ– 4 ä½ä»¥ 0 å¼€å¤´ï¼›A è‚¡ä¸º 6 ä½ã€‚`AkshareFetcher.is_hk(code)` ç”¨äºåˆ¤æ–­ã€‚
- **æ—¥çº¿**ï¼š`ak.stock_hk_hist(symbol, period="daily", start_date, end_date, adjust="qfq")`ï¼Œåˆ—åä¸ A è‚¡ç»Ÿä¸€æ ‡å‡†åŒ–ä¸º STANDARD_COLUMNSã€‚
- **å®æ—¶è¡Œæƒ…**ï¼š`ak.stock_hk_spot_em()`ï¼Œå…¨å¸‚åœºæ‹‰å–åæŒ‰ä»£ç åŒ¹é…ï¼›å­—æ®µä¸ A è‚¡ä¸€è‡´ï¼ˆæœ€æ–°ä»·ã€æ¶¨è·Œå¹…ã€é‡æ¯”ã€æ¢æ‰‹ç‡ç­‰ï¼‰ã€‚
- **ç­¹ç åˆ†å¸ƒ**ï¼šæ¸¯è‚¡æš‚æ— ä¸œæ–¹è´¢å¯Œç­¹ç æ¥å£ï¼Œ`get_chip_distribution` å¯¹æ¸¯è‚¡ç›´æ¥è¿”å› Noneï¼Œåˆ†ææ—¶ä»¥è¶‹åŠ¿ä¸é‡ä»·ã€å—å‘èµ„é‡‘ä¸ºä¸»ã€‚
- **å—å‘èµ„é‡‘ï¼ˆå¤§ç›˜å±‚é¢ï¼‰**ï¼š`market_analyzer` ä¸­ `_get_south_flow` ä½¿ç”¨ `ak.stock_hsgt_north_net_flow_in_em(symbol="å—ä¸‹")` å–å½“æ—¥å—å‘å‡€æµå…¥ï¼ˆäº¿å…ƒï¼‰ï¼Œä¸åŒ—å‘ä¸€å¹¶å†™å…¥ `MarketOverview`ï¼Œå¹¶åœ¨å¤ç›˜æç¤ºä¸æ¨¡æ¿ä¸­å±•ç¤ºã€‚

### ä¿¡æ¯é¢ä¸æ¨é€

- **æƒ…æŠ¥æœç´¢**ï¼šå¯¹æ¸¯è‚¡æ ‡çš„ï¼Œ`search_comprehensive_intel` å¢åŠ ã€Œæ¸¯è‚¡ä¸å—å‘èµ„é‡‘ã€ç»´åº¦ï¼ŒæŸ¥è¯¢è¯å«ã€Œæ¸¯è‚¡ å—å‘èµ„é‡‘ èµ„é‡‘æµå‘ã€ï¼›`format_intel_report` ä¸­å¯¹åº”è¾“å‡ºã€Œæ¸¯è‚¡ä¸å—å‘èµ„é‡‘ã€å°èŠ‚ã€‚
- **æ¨é€**ï¼š`notification.generate_daily_report` æ ¹æ®ç»“æœä¸­æ˜¯å¦å«æ¸¯è‚¡ï¼ˆå¦‚ 5 ä½ä»£ç ï¼‰åŠ¨æ€ä½¿ç”¨æ ‡é¢˜ã€ŒAè‚¡/æ¸¯è‚¡è‡ªé€‰è‚¡æ™ºèƒ½åˆ†ææŠ¥å‘Šã€ï¼›`send_batch_notifications` å¯¹æ¯æ¡åˆ†æç»“æœç»Ÿä¸€æ¨é€ï¼Œæ¸¯è‚¡ä¸ A è‚¡ä¸€è§†åŒä»ã€‚

### é…ç½®ä¸ä½¿ç”¨

- è‡ªé€‰åˆ—è¡¨ `STOCK_LIST` ä¸­å¯ç›´æ¥åŠ å…¥æ¸¯è‚¡ä»£ç ï¼ˆå¦‚ `00700,09988`ï¼‰ï¼Œä¸ A è‚¡æ··åˆåˆ†æï¼›å¤§ç›˜å¤ç›˜ä¼šè‡ªåŠ¨åŒ…å«å—å‘èµ„é‡‘ä¸æ¸¯è‚¡æŒ‡æ•°ï¼ˆæ’ç”Ÿç§‘æŠ€ç­‰ï¼‰ã€‚

---

## æ–°äººæ¥æ‰‹æ—¶å¼€å‘æ³¨æ„äº‹é¡¹ä»¥åŠå¦‚ä½•å¼€å§‹

### ç¯å¢ƒä¸è¿è¡Œ

1. **ç¯å¢ƒ**ï¼šPython 3.10+ï¼Œ`pip install -r requirements.txt`ï¼Œå¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™å¿…å¡«é¡¹ï¼ˆå¦‚ GEMINI_API_KEY æˆ– OPENAI_*ã€WECHAT_WEBHOOK_URLã€STOCK_LISTï¼‰ã€‚
2. **æœ¬åœ°è·‘é€š**ï¼š  
   - å®Œæ•´åˆ†æï¼š`python main.py`  
   - åªæ‹‰æ•°æ®ï¼š`python main.py --dry-run`  
   - åªå¤§ç›˜å¤ç›˜ï¼š`python main.py --market-review`  
   - æŒ‡å®šè‚¡ç¥¨ï¼š`python main.py --stocks 600519,000001,00700`ï¼ˆå¯æ··ç”¨ A è‚¡ä¸æ¸¯è‚¡ä»£ç ï¼‰  
   - è°ƒè¯•ï¼š`python main.py --debug`
3. **æ—¥å¿—**ï¼šåœ¨ `config.log_dir` ä¸‹æŒ‰æ—¥çš„ INFO ä¸ DEBUG è½®è½¬æ–‡ä»¶ï¼Œä¾¿äºæ’æŸ¥ LLM ä¸æ•°æ®é—®é¢˜ã€‚

### å¼€å‘ä¸æ‰©å±•

1. **æ–°å¢æ•°æ®æº**ï¼šåœ¨ `data_provider/` ä¸‹ç»§æ‰¿ `BaseFetcher`ï¼Œå®ç° `_fetch_raw_data`ã€`_normalize_data`ï¼Œè®¾ç½® `name` å’Œ `priority`ï¼Œåœ¨ `DataFetcherManager._init_default_fetchers` ä¸­æ³¨å†Œï¼ˆæˆ–é€šè¿‡æ„é€ æ³¨å…¥ fetchersï¼‰ã€‚
2. **æ–°å¢é€šçŸ¥æ¸ é“**ï¼šåœ¨ `notification.py` ä¸­æ‰©å±• NotificationServiceï¼ˆå¦‚é’‰é’‰/é£ä¹¦ï¼‰ï¼Œåœ¨ `send_batch_notifications` æˆ–å•ç‹¬å…¥å£ä¸­è°ƒç”¨ï¼›ä¼ä¸šå¾®ä¿¡é€»è¾‘å¯ä½œå‚è€ƒã€‚
3. **æ”¹æç¤ºè¯**ï¼š  
   - ä¸ªè‚¡ï¼šæ”¹ `analyzer.py` çš„ `SYSTEM_PROMPT` ä¸ `_format_prompt` çš„è¡¨æ ¼å’Œç»“å°¾è¦æ±‚ï¼›è‹¥æ”¹ JSON ç»“æ„éœ€åŒæ­¥ `_parse_response` å’Œ `AnalysisResult`/dashboard çš„ç”¨æ³•ã€‚  
   - å¤§ç›˜ï¼šæ”¹ `market_analyzer.py` çš„ `_build_review_prompt` å’Œæ¨¡æ¿ã€‚
4. **è¶‹åŠ¿è§„åˆ™**ï¼šä¿®æ”¹ `stock_analyzer.py` ä¸­é˜ˆå€¼ï¼ˆå¦‚ BIAS_THRESHOLDã€VOLUME_SHRINK_RATIOï¼‰æˆ–è¯„åˆ†æƒé‡ã€ä¿¡å·ç­‰çº§å³å¯ï¼Œæ— éœ€åŠ¨ AI æç¤ºè¯å³å¯å½±å“ `trend_analysis` æ³¨å…¥åˆ° prompt çš„å†…å®¹ã€‚
5. **å­˜å‚¨**ï¼šåˆ†æä¸Šä¸‹æ–‡ç›®å‰åªæœ‰è¿‘ 2 æ—¥ï¼›è‹¥å¸Œæœ›è¶‹åŠ¿åˆ†æåœ¨ pipeline ä¸­ç¨³å®šæ‹¿åˆ° 30 æ—¥ K çº¿ï¼Œå¯åœ¨ storage å¢åŠ  `get_analysis_context` çš„ `include_raw_data=True` æˆ–å•ç‹¬æ¥å£è¿”å›å¤šæ—¥ list/dictï¼Œå†åœ¨ main çš„ `analyze_stock` é‡Œç»„ DataFrame ä¼ ç»™ StockTrendAnalyzerã€‚
6. **è§„èŒƒ**ï¼šéµå¾ªé¡¹ç›®ç°æœ‰é£æ ¼ï¼ˆå•ä¾‹ã€dataclassã€ç±»å‹æ³¨è§£ã€loggingï¼‰ï¼Œæ–°å¢é…ç½®é¡¹æ”¾å…¥ Config ä¸ .env.exampleï¼Œå¹¶åœ¨ `validate()` ä¸­åšå¿…è¦æç¤ºã€‚

### æµ‹è¯•å»ºè®®

- å•è‚¡ + dry-runï¼šéªŒè¯æ•°æ®æºä¸ DB å†™å…¥ã€‚  
- å•è‚¡ + å…³é—­é€šçŸ¥ï¼šéªŒè¯åˆ†æé“¾è·¯ä¸æ—¥å¿—ä¸­çš„ prompt/responseã€‚  
- ä»…å¤§ç›˜å¤ç›˜ï¼šéªŒè¯ akshareã€æœç´¢ã€LLM æ¨¡æ¿/ç”Ÿæˆä¸æ¨é€ã€‚  
- ä¿®æ”¹æç¤ºè¯æˆ–è§„åˆ™åï¼Œç”¨ 1ï½2 åªè‚¡ç¥¨è·‘ä¸€è½®ï¼Œæ£€æŸ¥æŠ¥å‘Šä¸ä»ªè¡¨ç›˜å­—æ®µæ˜¯å¦ä»è§£ææ­£ç¡®ã€‚

---

## UMLå›¾è¯¦è§£

### 1. ç»„ä»¶/åŒ…ä¾èµ–æ¦‚è§ˆ

```mermaid
graph TB
    subgraph å…¥å£ä¸è°ƒåº¦
        MAIN[main.py<br/>StockAnalysisPipeline]
    end

    subgraph é…ç½®
        CFG[config.py<br/>Config]
    end

    subgraph AIä¸è§„åˆ™åˆ†æ
        ANL[analyzer.py<br/>GeminiAnalyzer]
        TREND[stock_analyzer.py<br/>StockTrendAnalyzer]
    end

    subgraph å¤§ç›˜ä¸æœç´¢
        MKT[market_analyzer.py<br/>MarketAnalyzer]
        SVC[search_service.py<br/>SearchService]
    end

    subgraph å­˜å‚¨ä¸é€šçŸ¥
        STO[storage.py<br/>DatabaseManager]
        NOT[notification.py<br/>NotificationService]
    end

    subgraph æ•°æ®æº
        MGR[DataFetcherManager]
        BASE[BaseFetcher]
        AK[AkshareFetcher]
        TS[TushareFetcher]
    end

    subgraph è°ƒåº¦
        SCH[scheduler.py<br/>Scheduler]
    end

    MAIN --> CFG
    MAIN --> STO
    MAIN --> MGR
    MAIN --> ANL
    MAIN --> TREND
    MAIN --> NOT
    MAIN --> SVC
    MAIN --> MKT
    MAIN --> SCH

    MKT --> SVC
    MKT --> ANL

    ANL --> CFG
    STO --> CFG
    MGR --> BASE
    MGR --> AK
    MGR --> TS
```

### 2. å•åªè‚¡ç¥¨åˆ†ææ—¶åºï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰

```mermaid
sequenceDiagram
    participant M as main.Pipeline
    participant F as DataFetcherManager
    participant S as storage
    participant A as AkshareFetcher
    participant T as StockTrendAnalyzer
    participant SV as SearchService
    participant AN as GeminiAnalyzer
    participant N as NotificationService

    M->>S: has_today_data(code)
    alt æ— ä»Šæ—¥æ•°æ®
        M->>F: get_daily_data(code, days=30)
        F-->>M: (df, source_name)
        M->>S: save_daily_data(df, code, source)
    end

    M->>A: get_realtime_quote(code)
    A-->>M: RealtimeQuote
    M->>A: get_chip_distribution(code)
    A-->>M: ChipDistribution

    M->>S: get_analysis_context(code)
    S-->>M: context
    opt è‹¥æœ‰ raw_data
        M->>T: analyze(df, code)
        T-->>M: TrendAnalysisResult
    end

    opt æœç´¢å¯ç”¨
        M->>SV: search_comprehensive_intel(code, name)
        SV-->>M: intel_results
        M->>SV: format_intel_report(intel_results, name)
        SV-->>M: news_context
    end

    M->>S: get_analysis_context(code)
    S-->>M: context
    M->>M: _enhance_context(context, realtime, chip, trend, name)
    M->>AN: analyze(enhanced_context, news_context)
    AN-->>M: AnalysisResult

    Note over M,N: æ‰€æœ‰è‚¡ç¥¨å®Œæˆå
    M->>N: generate_dashboard_report(results)
    N-->>M: report
    M->>N: save_report_to_file(report)
    M->>N: send_batch_notifications(results)
    N->>N: send_to_wechat(æ¯æ¡)
```

### 3. æ•°æ®æºç­–ç•¥ä¸å­˜å‚¨å…³ç³»

```mermaid
classDiagram
    class BaseFetcher {
        <<abstract>>
        +name: str
        +priority: int
        +get_daily_data(code, start, end, days)
        #_fetch_raw_data()
        #_normalize_data()
        #_clean_data()
        #_calculate_indicators()
    }

    class DataFetcherManager {
        -_fetchers: List~BaseFetcher~
        +get_daily_data(code, days) (df, source_name)
        -_init_default_fetchers()
    }

    class AkshareFetcher {
        +get_realtime_quote(code)
        +get_chip_distribution(code)
    }

    class DatabaseManager {
        -_instance
        +has_today_data(code, date)
        +save_daily_data(df, code, source)
        +get_latest_data(code, days)
        +get_analysis_context(code, date)
    }

    class StockDaily {
        +code
        +date
        +open, high, low, close
        +volume, amount, pct_chg
        +ma5, ma10, ma20, volume_ratio
        +data_source
    }

    BaseFetcher <|-- AkshareFetcher
    BaseFetcher <|-- TushareFetcher
    BaseFetcher <|-- BaostockFetcher
    BaseFetcher <|-- YfinanceFetcher
    DataFetcherManager o-- BaseFetcher
    DatabaseManager --> StockDaily : æŒä¹…åŒ–
```

### 4. æç¤ºè¯ä¸ç»“æœæµï¼ˆæ¦‚å¿µï¼‰

```mermaid
flowchart LR
    subgraph è¾“å…¥
        C[æŠ€æœ¯é¢ context]
        R[realtime/chip/trend]
        N[news_context]
    end

    subgraph æç¤ºè¯
        SP[SYSTEM_PROMPT<br/>äº¤æ˜“ç†å¿µ+JSONç»“æ„]
        UP[User Prompt<br/>_format_prompt]
    end

    subgraph LLM
        API[Gemini / OpenAI API]
    end

    subgraph è§£æä¸è¾“å‡º
        PARSE[_parse_response]
        AR[AnalysisResult<br/>+ dashboard]
    end

    C --> UP
    R --> UP
    N --> UP
    SP --> API
    UP --> API
    API --> PARSE
    PARSE --> AR
```

---

## é¡¹ç›®æ€»ç»“

- **å®šä½**ï¼šåŸºäº A è‚¡è‡ªé€‰è‚¡çš„**è‡ªåŠ¨åŒ–æ—¥é¢‘åˆ†æ + æ¨é€**ç³»ç»Ÿï¼Œç»“åˆè§„åˆ™å¼•æ“ï¼ˆè¶‹åŠ¿/ä¹–ç¦»ç‡/é‡èƒ½ï¼‰ä¸ LLMï¼ˆå†³ç­–ä»ªè¡¨ç›˜ + å¤§ç›˜å¤ç›˜ï¼‰ï¼Œé¢å‘ã€Œè¶‹åŠ¿äº¤æ˜“ã€ä¸¥è¿›ä¸è¿½é«˜ã€çš„å›ºå®šäº¤æ˜“ç†å¿µã€‚
- **æ¶æ„**ï¼šå…¥å£ä¸ç®¡é“åœ¨ mainï¼Œé…ç½®ä¸å­˜å‚¨å•ä¾‹ï¼Œæ•°æ®æºä¸æœç´¢ä¸ºå¯æ›¿æ¢ç­–ç•¥ï¼ŒAI ä¸è§„åˆ™åˆ†æåˆ†ç¦»ï¼ˆè§„åˆ™ç»“æœæ³¨å…¥ promptï¼‰ï¼Œé€šçŸ¥ä¸æŠ¥å‘Šç”Ÿæˆé›†ä¸­åœ¨ä¸€å¤„ï¼Œå±‚æ¬¡æ¸…æ™°ã€‚
- **æç¤ºè¯**ï¼šä¸ªè‚¡ä¸ºå¼ºçº¦æŸ JSON å†³ç­–ä»ªè¡¨ç›˜ï¼Œå¤§ç›˜ä¸º Markdown å…­æ®µå¼å¤ç›˜ï¼›ä¸¤å¤„å‡å¼ºè°ƒé£é™©ä¸å¯æ“ä½œç»“è®ºã€‚
- **æ‰©å±•ç‚¹**ï¼šæ–°æ•°æ®æºï¼ˆBaseFetcherï¼‰ã€æ–°é€šçŸ¥æ¸ é“ã€æ–°æœç´¢å¼•æ“ï¼ˆBaseSearchProviderï¼‰ã€æç¤ºè¯ä¸è¶‹åŠ¿å‚æ•°è°ƒæ•´ã€å­˜å‚¨ä¸­å¢åŠ å¤šæ—¥ raw_data ä¾›è¶‹åŠ¿åˆ†æç­‰ï¼Œå‡å¯æŒ‰ç°æœ‰æ¨¡å¼å¹³æ»‘æ‰©å±•ã€‚
- **è¿ç»´**ï¼šæ”¯æŒæœ¬åœ°ã€Dockerã€GitHub Actions å®šæ—¶ï¼›æ—¥å¿—ä¸ dry-runã€å•è‚¡æŒ‡å®šä¾¿äºæ’é”™ä¸è¿­ä»£ã€‚

---

*æ–‡æ¡£ç”Ÿæˆåå¯æ ¹æ®å®é™…ä»£ç å˜æ›´åšå°å¹…å¢è¡¥ï¼ˆå¦‚ storage å¢åŠ  raw_data æˆ–æ–° Fetcher çš„ priorityï¼‰ã€‚*
